name: Agent Verification (Node.js)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  verify:
    name: Verify (Node.js)
    runs-on: ubuntu-latest
    # Agent-Only: Run only on agent-authored PRs
    if: startsWith(github.actor, 'agent-') || github.actor == 'masseyl'
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate Node Project
        id: locate-project
        run: |
          if [ -f "apps/frontend/package.json" ]; then
            echo "project_dir=apps/frontend" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "project_dir=." >> $GITHUB_OUTPUT
          else
            echo "No Node project found (missing package.json)." >&2
            exit 1
          fi

      - name: Detect Package Manager
        id: detect-pm
        run: |
          PROJECT_DIR="${{ steps.locate-project.outputs.project_dir }}"
          if [ -f "$PROJECT_DIR/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=yarn" >> $GITHUB_OUTPUT
          elif [ -f "$PROJECT_DIR/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=pnpm" >> $GITHUB_OUTPUT
          elif [ -f "$PROJECT_DIR/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            echo "runner=npm" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=npm" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: ${{ steps.detect-pm.outputs.manager }}
          cache-dependency-path: |
            ${{ steps.locate-project.outputs.project_dir }}/package-lock.json
            ${{ steps.locate-project.outputs.project_dir }}/pnpm-lock.yaml
            ${{ steps.locate-project.outputs.project_dir }}/yarn.lock

      - name: Install pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install Dependencies
        id: install
        run: ${{ steps.detect-pm.outputs.runner }} ${{ steps.detect-pm.outputs.command }}
        working-directory: ${{ steps.locate-project.outputs.project_dir }}

      - name: Check Scripts
        id: check-scripts
        run: |
          PACKAGE_JSON="${{ steps.locate-project.outputs.project_dir }}/package.json"
          # Use jq to check for script existence in package.json
          echo "has_build=$(jq -r 'if .scripts.build then "true" else "false" end' "$PACKAGE_JSON")" >> $GITHUB_OUTPUT
          echo "has_test=$(jq -r 'if .scripts.test then "true" else "false" end' "$PACKAGE_JSON")" >> $GITHUB_OUTPUT
          if jq -e '.scripts.typecheck' "$PACKAGE_JSON" > /dev/null; then
            echo "has_typecheck=true" >> $GITHUB_OUTPUT
            echo "typecheck_script=typecheck" >> $GITHUB_OUTPUT
          elif jq -e '.scripts["type-check"]' "$PACKAGE_JSON" > /dev/null; then
            echo "has_typecheck=true" >> $GITHUB_OUTPUT
            echo "typecheck_script=type-check" >> $GITHUB_OUTPUT
          else
            echo "has_typecheck=false" >> $GITHUB_OUTPUT
            echo "typecheck_script=" >> $GITHUB_OUTPUT
          fi
          echo "has_lint=$(jq -r 'if .scripts.lint then "true" else "false" end' "$PACKAGE_JSON")" >> $GITHUB_OUTPUT

      - name: Build
        id: build
        if: steps.check-scripts.outputs.has_build == 'true'
        run: ${{ steps.detect-pm.outputs.runner }} run build
        working-directory: ${{ steps.locate-project.outputs.project_dir }}

      - name: Test
        id: test
        if: steps.check-scripts.outputs.has_test == 'true'
        run: ${{ steps.detect-pm.outputs.runner }} run test
        working-directory: ${{ steps.locate-project.outputs.project_dir }}

      - name: Typecheck
        id: typecheck
        if: steps.check-scripts.outputs.has_typecheck == 'true'
        run: ${{ steps.detect-pm.outputs.runner }} run ${{ steps.check-scripts.outputs.typecheck_script }}
        working-directory: ${{ steps.locate-project.outputs.project_dir }}

      - name: Lint
        id: lint
        if: steps.check-scripts.outputs.has_lint == 'true'
        run: ${{ steps.detect-pm.outputs.runner }} run lint
        working-directory: ${{ steps.locate-project.outputs.project_dir }}

      # --- Reporting ---

      - name: Report Success
        if: success()
        run: |
          # Add verified label, remove failed label (silently fail if not present)
          gh pr edit ${{ github.event.pull_request.number }} --add-label "agent:verified" || true
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "agent:verification-failed" || true
          
          # Optional: Post a 'clean' comment or just let the label speak?
          # For now, we only comment on failure to keep noise down, per Plan "compact report" usually implies failure or summary.
          # The PRD said "pass/fail status per step". Let's do a compact summary comment.
          
          cat <<EOF > report.md
          ### üõ°Ô∏è Agent Verification: Passed
          
          | Step | Status |
          |------|--------|
          | Build | ${{ steps.build.outcome || 'Skipped' }} |
          | Test | ${{ steps.test.outcome || 'Skipped' }} |
          | Typecheck | ${{ steps.typecheck.outcome || 'Skipped' }} |
          | Lint | ${{ steps.lint.outcome || 'Skipped' }} |
          
          ‚úÖ **Verified**
          EOF
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file report.md

      - name: Report Failure
        if: failure()
        run: |
          # Check for override label
          OVERRIDE="${{ contains(github.event.pull_request.labels.*.name, 'agent:verification-override') }}"
          
          if [ "$OVERRIDE" == "true" ]; then
            echo "‚ö†Ô∏è Verification failed but overridden by human label."
            # We do NOT apply the blocking label.
            # We still ensure 'agent:verified' is removed to avoid false confidence.
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "agent:verified" || true
            
            cat <<EOF > report.md
            ### üõ°Ô∏è Agent Verification: Failed (Overridden)
            
            > **Note**: A human has manually overridden this failure using the \`agent:verification-override\` label. This PR is allowed to merge despite verification errors.
            
            | Step | Status |
            |------|--------|
            | Install | ${{ steps.install.outcome }} |
            | Build | ${{ steps.build.outcome || 'Skipped' }} |
            | Test | ${{ steps.test.outcome || 'Skipped' }} |
            | Typecheck | ${{ steps.typecheck.outcome || 'Skipped' }} |
            | Lint | ${{ steps.lint.outcome || 'Skipped' }} |
            
            ‚ö†Ô∏è **Verification Failed (Bypassed)**
            Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            EOF
          else
            # Normal blocking failure
            gh pr edit ${{ github.event.pull_request.number }} --add-label "agent:verification-failed" || true
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "agent:verified" || true
            
            cat <<EOF > report.md
            ### üõ°Ô∏è Agent Verification: Failed
            
            | Step | Status |
            |------|--------|
            | Install | ${{ steps.install.outcome }} |
            | Build | ${{ steps.build.outcome || 'Skipped' }} |
            | Test | ${{ steps.test.outcome || 'Skipped' }} |
            | Typecheck | ${{ steps.typecheck.outcome || 'Skipped' }} |
            | Lint | ${{ steps.lint.outcome || 'Skipped' }} |
            
            ‚ùå **Verification Failed**
            Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            EOF
          fi
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file report.md
