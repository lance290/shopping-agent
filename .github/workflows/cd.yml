name: ğŸš€ Continuous Deployment

on:
  workflow_run:
    workflows: ["ğŸ§ª CI/CD Pipeline"]
    types:
      - completed
    branches: [main, staging]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      platform:
        description: 'Deployment platform'
        required: true
        default: 'both'
        type: choice
        options:
        - railway
        - gcp
        - both
      force_deploy:
        description: 'Force deployment (skip health checks)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine Deployment Strategy
  deployment-strategy:
    name: ğŸ¯ Deployment Strategy
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.strategy.outputs.environment }}
      platform: ${{ steps.strategy.outputs.platform }}
      should_deploy: ${{ steps.strategy.outputs.should_deploy }}
      deploy_railway: ${{ steps.strategy.outputs.deploy_railway }}
      deploy_gcp: ${{ steps.strategy.outputs.deploy_gcp }}
      force_deploy: ${{ steps.strategy.outputs.force_deploy }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Determine deployment strategy
      id: strategy
      run: |
        # Default values
        ENVIRONMENT="staging"
        PLATFORM="both"
        SHOULD_DEPLOY="false"
        DEPLOY_RAILWAY="false"
        DEPLOY_GCP="false"
        FORCE_DEPLOY="false"
        
        # Check workflow trigger
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          PLATFORM="${{ github.event.inputs.platform }}"
          FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
          SHOULD_DEPLOY="true"
        elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
          # Tag-based deployment
          if [[ "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            ENVIRONMENT="production"
          elif [[ "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            ENVIRONMENT="staging"
          else
            ENVIRONMENT="development"
          fi
          PLATFORM="both"
          SHOULD_DEPLOY="true"
        elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
          # CI workflow completed
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            ENVIRONMENT="${{ github.event.workflow_run.head_branch }}"
            PLATFORM="both"
            SHOULD_DEPLOY="true"
          fi
        fi
        
        # Set platform-specific flags
        if [[ "$PLATFORM" == "railway" || "$PLATFORM" == "both" ]]; then
          DEPLOY_RAILWAY="true"
        fi
        if [[ "$PLATFORM" == "gcp" || "$PLATFORM" == "both" ]]; then
          DEPLOY_GCP="true"
        fi
        
        # Validate environment
        if [[ ! "$ENVIRONMENT" =~ ^(development|staging|production)$ ]]; then
          echo "âŒ Invalid environment: $ENVIRONMENT"
          exit 1
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "deploy_railway=$DEPLOY_RAILWAY" >> $GITHUB_OUTPUT
        echo "deploy_gcp=$DEPLOY_GCP" >> $GITHUB_OUTPUT
        echo "force_deploy=$FORCE_DEPLOY" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Deployment Strategy:"
        echo "  Environment: $ENVIRONMENT"
        echo "  Platform: $PLATFORM"
        echo "  Should Deploy: $SHOULD_DEPLOY"
        echo "  Deploy Railway: $DEPLOY_RAILWAY"
        echo "  Deploy GCP: $DEPLOY_GCP"
        echo "  Force Deploy: $FORCE_DEPLOY"

  # Pre-deployment Health Check
  pre-deployment-check:
    name: ğŸ” Pre-deployment Check
    runs-on: ubuntu-latest
    needs: deployment-strategy
    if: needs.deployment-strategy.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Validate environment
      run: |
        echo "ğŸ” Validating ${{ needs.deployment-strategy.outputs.environment }} environment..."
        
        # Make scripts executable
        chmod +x tools/validate-secrets.sh
        chmod +x tools/setup-env.sh
        
        # Validate environment configuration
        if [[ -f "tools/validate-secrets.sh" ]]; then
          ./tools/validate-secrets.sh || echo "âš ï¸ Validation completed with warnings"
        else
          echo "âš ï¸ Validation script not found"
        fi
        
    - name: ğŸ§ª Run pre-deployment tests
      run: |
        echo "ğŸ§ª Running pre-deployment tests..."
        
        # Create test environment
        cat > .env << EOF
        NODE_ENV=test
        DATABASE_URL=postgresql://test:test@localhost:5432/test
        REDIS_URL=redis://localhost:6379
        JWT_SECRET=test-secret-for-ci
        EOF
        
        # Run service tests
        if [[ -f "tools/service-specific-tests.sh" ]]; then
          chmod +x tools/service-specific-tests.sh
          ./tools/service-specific-tests.sh all test || echo "âš ï¸ Pre-deployment tests completed with warnings"
        else
          echo "âš ï¸ Service tests not found"
        fi

  # Railway Deployment
  deploy-railway:
    name: ğŸš‚ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [deployment-strategy, pre-deployment-check]
    if: |
      needs.deployment-strategy.outputs.should_deploy == 'true' && 
      needs.deployment-strategy.outputs.deploy_railway == 'true'
    environment:
      name: ${{ needs.deployment-strategy.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸš‚ Setup Railway CLI
      run: npm install -g @railway/cli
      
    - name: ğŸ” Login to Railway
      run: railway login --token ${{ secrets.RAILWAY_TOKEN }}
      
    - name: ğŸ”§ Configure Railway project
      run: |
        echo "ğŸ”§ Configuring Railway project..."
        
        # Link project if needed
        if ! railway status; then
          echo "ğŸ”— Linking Railway project..."
          railway link
        fi
        
        # Generate service configuration
        if [[ -f "infra/railway/config-railway.js" ]]; then
          echo "ğŸ”§ Generating Railway configuration..."
          node infra/railway/config-railway.js generate
        fi
        
        # Set environment variables
        echo "ğŸ”§ Setting environment variables..."
        
        # Core variables
        railway variables set NODE_ENV="${{ needs.deployment-strategy.outputs.environment }}"
        railway variables set PORT=8080
        
        # Database variables (if configured)
        if [[ -n "${{ secrets.DATABASE_URL }}" ]]; then
          railway variables set DATABASE_URL="${{ secrets.DATABASE_URL }}"
        fi
        
        if [[ -n "${{ secrets.REDIS_URL }}" ]]; then
          railway variables set REDIS_URL="${{ secrets.REDIS_URL }}"
        fi
        
        # External service variables
        if [[ -n "${{ secrets.JWT_SECRET }}" ]]; then
          railway variables set JWT_SECRET="${{ secrets.JWT_SECRET }}"
        fi
        
        if [[ -n "${{ secrets.STRIPE_SECRET_KEY }}" ]]; then
          railway variables set STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}"
        fi
        
        echo "âœ… Railway configuration completed"
        
    - name: ğŸš‚ Deploy to Railway
      id: deploy
      run: |
        echo "ğŸš‚ Deploying to Railway..."
        
        # Deploy all services
        railway up
        
        # Wait for deployment to complete
        echo "â³ Waiting for deployment to complete..."
        sleep 60
        
        # Get service URLs
        SERVICE_URLS=$(railway status --json | jq -r '.[].url' | head -1)
        echo "url=$SERVICE_URLS" >> $GITHUB_OUTPUT
        
        echo "âœ… Railway deployment completed"
        echo "ğŸŒ Service URL: $SERVICE_URLS"
        
    - name: ğŸ§ª Verify Railway deployment
      run: |
        echo "ğŸ§ª Verifying Railway deployment..."
        
        SERVICE_URL="${{ steps.deploy.outputs.url }}"
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        while [[ $RETRY_COUNT -lt $MAX_RETRIES ]]; do
          if curl -f "$SERVICE_URL/health" --max-time 30; then
            echo "âœ… Railway health check passed"
            break
          else
            echo "â³ Health check failed, retrying... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
            sleep 30
            ((RETRY_COUNT++))
          fi
        done
        
        if [[ $RETRY_COUNT -eq $MAX_RETRIES ]]; then
          echo "âŒ Railway health check failed after $MAX_RETRIES attempts"
          if [[ "${{ needs.deployment-strategy.outputs.force_deploy }}" != "true" ]]; then
            exit 1
          fi
        fi
        
    - name: ğŸ“Š Railway deployment info
      run: |
        echo "ğŸ“Š Railway deployment information:"
        railway status
        echo ""
        echo "ğŸŒ Service URLs:"
        railway status --json | jq -r '.[] | "â€¢ \(.name): \(.url)"'

  # GCP Deployment
  deploy-gcp:
    name: â˜ï¸ Deploy to GCP
    runs-on: ubuntu-latest
    needs: [deployment-strategy, pre-deployment-check]
    if: |
      needs.deployment-strategy.outputs.should_deploy == 'true' && 
      needs.deployment-strategy.outputs.deploy_gcp == 'true'
    environment:
      name: ${{ needs.deployment-strategy.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
      
    permissions:
      contents: 'read'
      id-token: 'write'
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Setup GCP CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Artifact Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.GCP_REGION }}-docker.pkg.dev
        username: _json_key
        password: ${{ secrets.GCP_SA_KEY }}
        
    - name: ğŸ—ï¸ Build and push Docker image
      run: |
        echo "ğŸ—ï¸ Building Docker image for ${{ needs.deployment-strategy.outputs.environment }}..."
        
        # Determine image tag
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          IMAGE_TAG="${{ github.ref_name }}"
        else
          IMAGE_TAG="${{ github.sha }}"
        fi
        
        IMAGE_PATH="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/app:$IMAGE_TAG"
        
        # Build and push
        docker build \
          --build-arg NODE_ENV="${{ needs.deployment-strategy.outputs.environment }}" \
          -t "$IMAGE_PATH" \
          .
        docker push "$IMAGE_PATH"
        
        echo "âœ… Docker image pushed: $IMAGE_PATH"
        echo "image_path=$IMAGE_PATH" >> $GITHUB_ENV
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV
        
    - name: ğŸ”§ Deploy GCP infrastructure
      run: |
        echo "ğŸ”§ Deploying GCP infrastructure..."
        
        cd infra/pulumi
        
        # Install Pulumi dependencies
        npm install
        
        # Select stack
        STACK_NAME="${{ needs.deployment-strategy.outputs.environment }}"
        
        # Deploy infrastructure
        pulumi up --stack="$STACK_NAME" --yes
        
        echo "âœ… GCP infrastructure deployed"
        
    - name: â˜ï¸ Deploy to Cloud Run
      id: deploy
      run: |
        echo "â˜ï¸ Deploying to Cloud Run..."
        
        # Determine service name
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          SERVICE_NAME="${{ needs.deployment-strategy.outputs.environment }}-${{ github.ref_name }}"
        else
          SERVICE_NAME="${{ needs.deployment-strategy.outputs.environment }}-${{ github.sha }}"
        fi
        
        # Set resource limits based on environment
        MEMORY_LIMIT="512Mi"
        CPU_LIMIT="1"
        
        if [[ "${{ needs.deployment-strategy.outputs.environment }}" == "production" ]]; then
          MEMORY_LIMIT="1Gi"
          CPU_LIMIT="2"
        elif [[ "${{ needs.deployment-strategy.outputs.environment }}" == "staging" ]]; then
          MEMORY_LIMIT="768Mi"
          CPU_LIMIT="1"
        fi
        
        # Deploy to Cloud Run
        gcloud run deploy "$SERVICE_NAME" \
          --image="$IMAGE_PATH" \
          --region="${{ secrets.GCP_REGION }}" \
          --platform=managed \
          --allow-unauthenticated \
          --memory="$MEMORY_LIMIT" \
          --cpu="$CPU_LIMIT" \
          --set-env-vars="NODE_ENV=${{ needs.deployment-strategy.outputs.environment }}" \
          --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }}" \
          --set-env-vars="REDIS_URL=${{ secrets.REDIS_URL }}" \
          --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
          --set-env-vars="STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}" \
          --quiet
          
        # Get service URL
        SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
          --region="${{ secrets.GCP_REGION }}" \
          --format="value(status.url)")
          
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
        
        echo "âœ… GCP deployment completed"
        echo "ğŸŒ Service URL: $SERVICE_URL"
        
    - name: ğŸ§ª Verify GCP deployment
      run: |
        echo "ğŸ§ª Verifying GCP deployment..."
        
        SERVICE_URL="${{ steps.deploy.outputs.url }}"
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        while [[ $RETRY_COUNT -lt $MAX_RETRIES ]]; do
          if curl -f "$SERVICE_URL/health" --max-time 30; then
            echo "âœ… GCP health check passed"
            break
          else
            echo "â³ Health check failed, retrying... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
            sleep 30
            ((RETRY_COUNT++))
          fi
        done
        
        if [[ $RETRY_COUNT -eq $MAX_RETRIES ]]; then
          echo "âŒ GCP health check failed after $MAX_RETRIES attempts"
          if [[ "${{ needs.deployment-strategy.outputs.force_deploy }}" != "true" ]]; then
            exit 1
          fi
        fi
        
    - name: ğŸ“Š GCP deployment info
      run: |
        echo "ğŸ“Š GCP deployment information:"
        echo "Service: ${{ steps.deploy.outputs.service_name }}"
        echo "Image: ${{ env.image_path }}"
        echo "Region: ${{ secrets.GCP_REGION }}"
        echo ""
        echo "ğŸŒ Service URL: ${{ steps.deploy.outputs.url }}"

  # Post-deployment Health Check
  post-deployment-check:
    name: ğŸ¥ Post-deployment Check
    runs-on: ubuntu-latest
    needs: [deployment-strategy, deploy-railway, deploy-gcp]
    if: always() && (needs.deploy-railway.result == 'success' || needs.deploy-gcp.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ¥ Run comprehensive health checks
      run: |
        echo "ğŸ¥ Running post-deployment health checks..."
        
        # Make scripts executable
        chmod +x tools/health-check.sh
        chmod +x tools/service-specific-tests.sh
        
        # Create environment file
        cat > .env << EOF
        NODE_ENV=${{ needs.deployment-strategy.outputs.environment }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        REDIS_URL=${{ secrets.REDIS_URL }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOF
        
        # Run health check
        if [[ -f "tools/health-check.sh" ]]; then
          echo "ğŸ” Running comprehensive health check..."
          ./tools/health-check.sh ${{ needs.deployment-strategy.outputs.environment }} local || echo "âš ï¸ Health check completed with warnings"
        else
          echo "âš ï¸ Health check script not found"
        fi
        
        # Run service tests
        if [[ -f "tools/service-specific-tests.sh" ]]; then
          echo "ğŸ” Running service-specific tests..."
          ./tools/service-specific-tests.sh all ${{ needs.deployment-strategy.outputs.environment }} || echo "âš ï¸ Service tests completed with warnings"
        else
          echo "âš ï¸ Service tests not found"
        fi
        
        echo "âœ… Post-deployment checks completed"

  # Performance Tests
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [deployment-strategy, deploy-railway, deploy-gcp]
    if: |
      always() && 
      (needs.deploy-railway.result == 'success' || needs.deploy-gcp.result == 'success') &&
      needs.deployment-strategy.outputs.environment != 'development'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: âš¡ Install performance testing tools
      run: |
        npm install -g artillery
        npm install -g lighthouse
        
    - name: âš¡ Run load tests
      run: |
        echo "âš¡ Running load tests..."
        
        # Create load test configuration
        cat > load-test.yml << EOF
        config:
          target: '${{ needs.deploy-railway.result == "success" && steps.railway-deploy.outputs.url || steps.gcp-deploy.outputs.url }}'
          phases:
            - duration: 60
              arrivalRate: 5
              name: "Warm up"
            - duration: 120
              arrivalRate: 10
              name: "Load test"
        scenarios:
          - name: "Health check"
            weight: 50
            flow:
              - get:
                  url: "/health"
          - name: "API test"
            weight: 50
            flow:
              - get:
                  url: "/api/status"
        EOF
        
        # Run load test
        artillery run load-test.yml || echo "âš ï¸ Load test completed with warnings"
        
    - name: ğŸŒŸ Run Lighthouse tests
      run: |
        echo "ğŸŒŸ Running Lighthouse tests..."
        
        # Test if Lighthouse is available
        if command -v lighthouse &> /dev/null; then
          SERVICE_URL="${{ needs.deploy-railway.result == "success" && steps.railway-deploy.outputs.url || steps.gcp-deploy.outputs.url }}"
          
          lighthouse "$SERVICE_URL" \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless" \
            --quiet || echo "âš ï¸ Lighthouse test completed with warnings"
            
          echo "âœ… Lighthouse tests completed"
        else
          echo "âš ï¸ Lighthouse not available"
        fi
        
    - name: ğŸ“Š Upload performance reports
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: performance-reports
        path: |
          lighthouse-report.json
          load-test.yml

  # Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [deployment-strategy, deploy-railway, deploy-gcp]
    if: |
      always() && 
      (needs.deploy-railway.result == 'success' || needs.deploy-gcp.result == 'success') &&
      needs.deployment-strategy.outputs.environment == 'production'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run security scan
      run: |
        echo "ğŸ”’ Running security scan..."
        
        # Get service URL
        SERVICE_URL="${{ needs.deploy-railway.result == "success" && steps.railway-deploy.outputs.url || steps.gcp-deploy.outputs.url }}"
        
        # Test for security headers
        echo "ğŸ” Checking security headers..."
        SECURITY_HEADERS=$(curl -s -I "$SERVICE_URL" | grep -i -E "x-frame-options|x-content-type-options|content-security-policy|x-xss-protection" || echo "")
        
        if [[ -n "$SECURITY_HEADERS" ]]; then
          echo "âœ… Security headers found:"
          echo "$SECURITY_HEADERS"
        else
          echo "âš ï¸ Security headers missing"
        fi
        
        # Test for HTTPS enforcement
        echo "ğŸ” Checking HTTPS enforcement..."
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://$SERVICE_URL" || echo "000")
        
        if [[ "$HTTP_STATUS" == "301" || "$HTTP_STATUS" == "30" ]]; then
          echo "âœ… HTTPS properly enforced"
        else
          echo "âš ï¸ HTTPS enforcement may be missing"
        fi
        
        echo "âœ… Security scan completed"

  # Rollback (if needed)
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [deployment-strategy, post-deployment-check, performance-tests, security-scan]
    if: |
      failure() && 
      needs.deployment-strategy.outputs.force_deploy != 'true' &&
      (needs.deploy-railway.result == 'failure' || needs.deploy-gcp.result == 'failure' ||
       needs.post-deployment-check.result == 'failure')
    
    steps:
    - name: ğŸ”„ Rollback Railway
      if: needs.deploy-railway.result == 'failure'
      run: |
        echo "ğŸ”„ Rolling back Railway deployment..."
        
        npm install -g @railway/cli
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        
        # Rollback to previous deployment
        railway rollback
        
        echo "âœ… Railway rollback completed"
        
    - name: ğŸ”„ Rollback GCP
      if: needs.deploy-gcp.result == 'failure'
      run: |
        echo "ğŸ”„ Rolling back GCP deployment..."
        
        # Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
        # Setup GCP CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          
        # Get previous revision
        PREVIOUS_REVISION=$(gcloud run services revisions list \
          --service="${{ needs.deployment-strategy.outputs.environment }}" \
          --region="${{ secrets.GCP_REGION }}" \
          --limit=2 \
          --format="value(name)" | tail -1)
          
        # Rollback to previous revision
        if [[ -n "$PREVIOUS_REVISION" ]]; then
          gcloud run services update "${{ needs.deployment-strategy.outputs.environment }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --revision="$PREVIOUS_REVISION"
          echo "âœ… GCP rollback completed to $PREVIOUS_REVISION"
        else
          echo "âš ï¸ No previous revision found for rollback"
        fi

  # Notification
  notify:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deployment-strategy, deploy-railway, deploy-gcp, post-deployment-check, performance-tests, security-scan, rollback]
    if: always()
    
    steps:
    - name: ğŸ“¢ Build deployment notification
      id: message
      run: |
        ENVIRONMENT="${{ needs.deployment-strategy.outputs.environment }}"
        PLATFORM="${{ needs.deployment-strategy.outputs.platform }}"
        
        MESSAGE="## ğŸš€ Deployment Complete
        
        **Environment:** $ENVIRONMENT
        **Platform:** $PLATFORM
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        
        ### ğŸ“Š Deployment Results:
        
        - ğŸš‚ **Railway:** ${{ needs.deploy-railway.result }}
        - â˜ï¸ **GCP:** ${{ needs.deploy-gcp.result }}"
        - ğŸ¥ **Post-deployment Check:** ${{ needs.post-deployment-check.result }}"
        - âš¡ **Performance Tests:** ${{ needs.performance-tests.result }}"
        - ğŸ”’ **Security Scan:** ${{ needs.security-scan.result }}"
        
        ### ğŸ¯ Overall Status: "
        
        # Determine overall status
        if [[ "${{ needs.deploy-railway.result }}" == "failure" || "${{ needs.deploy-gcp.result }}" == "failure" || "${{ needs.post-deployment-check.result }}" == "failure" ]]; then
          if [[ "${{ needs.rollback.result }}" == "success" ]]; then
            MESSAGE="$MESSAGEğŸ”„ ROLLED BACK"
          else
            MESSAGE="$MESSAGEâŒ FAILED"
          fi
        elif [[ "${{ needs.performance-tests.result }}" == "failure" || "${{ needs.security-scan.result }}" == "failure" ]]; then
          MESSAGE="$MESSAGEâš ï¸ SUCCESS WITH ISSUES"
        else
          MESSAGE="$MESSAGEâœ… SUCCESS"
        fi
        
        # Add service URLs
        if [[ "${{ needs.deploy-railway.result }}" == "success" ]]; then
          MESSAGE="$MESSAGE
        
        ### ğŸŒ Railway URLs:
        - Railway Service: ${{ needs.deploy-railway.outputs.url }}"
        "
        fi
        
        if [[ "${{ needs.deploy-gcp.result }}" == "success" ]]; then
          MESSAGE="$MESSAGE
        ### ğŸŒ GCP URLs:
        - GCP Service: ${{ needs.deploy-gcp.outputs.url }}"
        "
        fi
        
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "$MESSAGE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¢ Post to Slack
      if: env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"${{ steps.message.outputs.message }}"}' \
          "$SLACK_WEBHOOK_URL"
          
    - name: ğŸ“¢ Create GitHub Release
      if: github.ref_type == 'tag' && needs.deploy-railway.result == 'success' && needs.deploy-gcp.result == 'success'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ${{ steps.message.outputs.message }}
          
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}

  # Cleanup
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deployment-strategy, deploy-gcp]
    if: always() && needs.deploy-gcp.result == 'success'
    
    steps:
    - name: ğŸ” Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Setup GCP CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: ğŸ§¹ Cleanup old deployments
      run: |
        echo "ğŸ§¹ Cleaning up old Cloud Run deployments..."
        
        # Keep only last 3 deployments per environment
        gcloud run services list \
          --region="${{ secrets.GCP_REGION }}" \
          --format="value(name)" \
          | grep "${{ needs.deployment-strategy.outputs.environment }}" \
          | sort -r \
          | tail -n +4 \
          | xargs -r -I {} gcloud run services delete {} \
            ---region="${{ secrets.GCP_REGION }}" \
            --quiet
            
        echo "âœ… Cleanup completed"
